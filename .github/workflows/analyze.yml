name: ðŸ” Code Quality

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    - cron: '0 2 * * MON'  # Every Monday at 2 AM UTC

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  analyze:
    name: ðŸ“Š Flutter Analyze
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸŽ¯ Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.x'
          cache: true

      - name: ðŸ“¦ Get dependencies
        working-directory: miganado
        run: flutter pub get

      - name: ðŸ” Analyze
        working-directory: miganado
        run: flutter analyze lib/ test/ --fatal-warnings || true

      - name: ðŸ“Š Report Issues
        if: failure()
        run: |
          echo "## ðŸ” Code Analysis Issues Found" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Please review and fix the issues reported above." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Common fixes:**" >> $GITHUB_STEP_SUMMARY
          echo "- Remove unused imports: \`dart format\`" >> $GITHUB_STEP_SUMMARY
          echo "- Follow conventions: Check analysis_options.yaml" >> $GITHUB_STEP_SUMMARY

  format:
    name: ðŸŽ¨ Code Format Check
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸŽ¯ Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.x'
          cache: true

      - name: ðŸ“¦ Get dependencies
        working-directory: miganado
        run: flutter pub get

      - name: ðŸŽ¨ Check format
        working-directory: miganado
        run: |
          dart format --set-exit-if-changed lib/ test/ || (
            echo "## âŒ Code Format Issues" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Run locally: \`dart format lib/ test/\`" >> $GITHUB_STEP_SUMMARY
            exit 1
          )

  dependencies:
    name: ðŸ”— Dependency Check
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸŽ¯ Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.x'
          cache: true

      - name: ðŸ“¦ Get dependencies
        working-directory: miganado
        run: flutter pub get

      - name: ðŸ”— Check dependencies
        working-directory: miganado
        run: |
          echo "## ðŸ“¦ Dependency Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          flutter pub outdated --no-dev-dependencies >> $GITHUB_STEP_SUMMARY || true

      - name: ðŸš¨ Check for vulnerabilities
        working-directory: miganado
        run: flutter pub publish --dry-run || true
        continue-on-error: true

  security-scan:
    name: ðŸ” Security Scan
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ” Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: 'miganado'
          format: 'sarif'
          output: 'trivy-results.sarif'
        continue-on-error: true

      - name: ðŸ“¤ Upload Trivy results
        uses: github/codeql-action/upload-sarif@v4
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'
        continue-on-error: true

  summary:
    name: âœ… Quality Check Summary
    runs-on: ubuntu-latest
    needs: [ analyze, format, dependencies, security-scan ]
    if: always()

    steps:
      - name: ðŸ“‹ Generate Summary
        run: |
          echo "## ðŸ“Š Code Quality Check Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ” Flutter Analyze | ${{ needs.analyze.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸŽ¨ Code Format | ${{ needs.format.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ”— Dependencies | ${{ needs.dependencies.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ” Security | ${{ needs.security-scan.result }} |" >> $GITHUB_STEP_SUMMARY
